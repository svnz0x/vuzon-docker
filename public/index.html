<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta id="ios-statusbar" name="apple-mobile-web-app-status-bar-style" content="default">
    <script>
    (function(){try{
      var m=document.querySelector('#ios-statusbar'); if(!m) return;
      var mq=window.matchMedia('(prefers-color-scheme: dark)');
      var apply=function(){m.setAttribute('content', mq.matches?'black':'default');};
      apply();
      if(mq.addEventListener) mq.addEventListener('change', apply);
      else if(mq.addListener) mq.addListener(apply);
    }catch(e){}})();
  </script>

  <!-- Favicons para navegador -->
  <link rel="icon" href="/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">

  <!-- iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">

  <!-- PWA -->
  <link rel="manifest" href="/site.webmanifest">

  <title>vuzon</title>
<style>
    /* --- Base / Reset ---------------------------------------------------- */
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    :root {
      color-scheme: light dark;
      --brand: #f5b31f;
      --brand-2: #f0c441;
      --ink: #111827;
      --ink-muted: #6b7280;
      --ink-strong: #000000;
      --panel: #ffffff;
      --radius: 16px;
      --shadow: 0 18px 40px rgba(0,0,0,.10);
      --space-1: 4px;  --space-2: 8px;  --space-3: 12px;  --space-4: 16px;
      --space-5: 20px; --space-6: 24px; --space-7: 28px; --space-8: 32px;
      --label-w: 84px; /* ancho guía para etiquetas en móvil (antes 96px) */
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
    }

    body {
      margin: 0; color: var(--ink);
      background: #ffffff;
      min-height: 100dvh;
      padding: max(env(safe-area-inset-top), 20px) max(env(safe-area-inset-right), 20px) max(env(safe-area-inset-bottom), 20px) max(env(safe-area-inset-left), 20px);
      line-height: 1.5;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --ink: #e5e7eb;
        --ink-muted: #9ca3af;
        --ink-strong: #ffffff;
        --panel: #0d0d0d;
        --shadow: 0 18px 40px rgba(0,0,0,.7);
      }
      body { background: #000000; }
    }

    /* ---- Contenido ------------------------------------------------------ */
    .page-spacer { height: 64px; }
    /* Collapsible */
    #toggleExistentes .icon { transition: transform .2s ease; }
    #toggleExistentes[aria-expanded="false"] .icon { transform: rotate(-90deg); }
    #toggleDestinatarios .icon { transition: transform .2s ease; }
    #toggleDestinatarios[aria-expanded="false"] .icon { transform: rotate(-90deg); }
    main { width: min(960px, 100%); margin: 0 auto; display: grid; gap: var(--space-6); }

    /* Barra de título con botón a la derecha */
    .titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    h1 { color: var(--ink-strong); font-size: clamp(1.6rem, 1.6rem + 1vw, 3rem); margin: 0; letter-spacing: -0.01em; line-height: 1.1; text-shadow: 0 1px 0 rgba(255,255,255,.7); }
    @media (prefers-color-scheme: dark) { h1 { text-shadow: none; } }

    h2 { font-size: clamp(1rem, .95rem + .4vw, 1.2rem); margin: 0; color: var(--ink-strong); }

    /* Panels */
    section { background: var(--panel); border-radius: calc(var(--radius) + 2px); padding: var(--space-6); box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,.08); backdrop-filter: blur(6px); }
    @media (prefers-color-scheme: dark) { section { border-color: rgba(255,255,255,.12); } }
    section header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: var(--space-4); margin-bottom: var(--space-4); }

    .stack { display: grid; gap: var(--space-4); }

    /* Forms */
    label { font-weight: 600; font-size: .92rem; color: var(--ink-strong); }
    input, select, button { width: auto; min-height: 44px; font-size: 16px; padding: 10px 14px; border-radius: 12px; border: 1px solid #e2e8f0; background: #ffffff; color: var(--ink); transition: border .2s ease, box-shadow .2s ease, transform .15s ease; }
    input::placeholder { color: #6b7280; opacity: 1; }
    select option { color: var(--ink); }
    input:focus-visible, select:focus-visible, button:focus-visible { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand), transparent 75%); }

    @media (prefers-color-scheme: dark) {
      input, select { background: #0f0f0f; border-color: rgba(255,255,255,.24); color: var(--ink); }
      input::placeholder { color: #b7c3d9; }
    }

    button { background: linear-gradient(135deg, var(--brand-2), var(--brand)); border: none; color: #3c2d00; font-weight: 700; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,.22); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    button:hover { transform: translateY(-1px); box-shadow: 0 9px 22px rgba(0,0,0,.3); }
    @media (prefers-reduced-motion: reduce) { button:hover { transform: none; } }
    button.secondary { background: transparent; color: var(--ink); border: 1px solid rgba(0,0,0,.18); box-shadow: none; }
    button.secondary:hover { background: #f3f4f6; }
    @media (prefers-color-scheme: dark) {
      button.secondary { color: var(--ink); border-color: rgba(255,255,255,.24); }
      button.secondary:hover { background: rgba(255,255,255,.08); }
    }
    button.sm { min-height: 32px; padding: 6px 10px; font-size: 12px; border-radius: 10px; }
    .btns { display: inline-flex; gap: 8px; flex-wrap: wrap; }
    .icon { width: 16px; height: 16px; flex: 0 0 16px; }
    .btn-text { display: inline; }

    .section-actions { display: flex; gap: var(--space-3); flex-wrap: wrap; }
    .table-actions { display: flex; gap: var(--space-3); align-items: center; flex-wrap: wrap; }

    /* Rule cards */
    .rule-card-list { display: grid; gap: var(--space-4); }
    .rule-card { border: 1px solid rgba(0,0,0,.08); border-radius: 16px; background: var(--panel); box-shadow: var(--shadow); overflow: hidden; transition: border-color .2s ease; }
    .rule-card summary { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-5); list-style: none; cursor: pointer; font-weight: 600; color: var(--ink-strong); }
    .rule-card summary::-webkit-details-marker { display: none; }
    .rule-card summary:focus-visible { outline: 2px solid color-mix(in oklab, var(--brand), transparent 60%); outline-offset: 2px; border-radius: 12px; }
    .rule-card summary::after { content: ''; width: 10px; height: 10px; border-right: 2px solid currentColor; border-bottom: 2px solid currentColor; transform: rotate(-45deg); margin-left: auto; transition: transform .2s ease; opacity: .5; }
    .rule-card[open] summary::after { transform: rotate(45deg); }
    .rule-summary { display: flex; align-items: center; gap: var(--space-3); flex-wrap: wrap; flex: 1 1 auto; }
    .rule-title { font-size: 1rem; }
    .rule-content { display: grid; gap: var(--space-4); padding: 0 var(--space-5) var(--space-5); }
    .rule-field { display: grid; gap: 4px; }
    .rule-label { font-size: .72rem; letter-spacing: .06em; text-transform: uppercase; color: var(--ink-muted); font-weight: 700; }
    .rule-value { color: var(--ink); }
    .rule-empty { color: var(--ink-muted); font-size: .95rem; padding: var(--space-5); border: 1px dashed rgba(0,0,0,.16); border-radius: 16px; text-align: center; background: color-mix(in srgb, var(--panel) 90%, transparent); }

    /* Spinner mínimo */
    .spinner { width: 14px; height: 14px; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin .6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn-label { display: inline-block; min-width: 8ch; text-align: center; }

    /* Tables */
    .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: var(--space-1); container-type: inline-size; }
    .table-container::-webkit-scrollbar { height: 6px; }
    .table-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,.25); border-radius: 999px; }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; background: rgba(255,255,255,.9); box-shadow: inset 0 1px 0 rgba(0,0,0,.06); table-layout: fixed; }
    thead { background: rgba(245,179,31,.18); color: var(--ink); text-transform: uppercase; font-size: .75rem; letter-spacing: .06em; }
    th, td { padding: 12px 16px; border-bottom: 1px solid rgba(50,74,109,.08); text-align: left; vertical-align: top; }
    th { white-space: nowrap; }
    td, th { overflow-wrap: anywhere; }

    tbody tr:nth-child(2n) { background: #f9fafb; }
    tbody tr:hover { background: #eef2f7; }

    @media (prefers-color-scheme: dark) {
      table { background: #0f0f0f; box-shadow: inset 0 1px 0 rgba(255,255,255,.06); }
      thead { background: rgba(245,179,31,.22); color: var(--ink-strong); }
      tbody tr:nth-child(2n) { background: rgba(255,255,255,.04); }
      tbody tr:hover { background: rgba(255,255,255,.06); }
      .rule-card { border-color: rgba(255,255,255,.12); }
      .rule-empty { border-color: rgba(255,255,255,.16); background: color-mix(in srgb, var(--panel) 75%, transparent); }
    }

    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: .78rem; font-weight: 700; white-space: nowrap; }
    .badge.success { background: rgba(72,199,142,.2); color: #1f7a54; }
    .badge.pending { background: rgba(245,179,31,.22); color: #513c00; }
    @media (prefers-color-scheme: dark) {
      .badge.success { background: rgba(72,199,142,.25); color: #9fe4c2; }
      .badge.pending { background: rgba(245,179,31,.25); color: #ffe29a; }
    }

    /* Utilidades de truncado/clamp */
    .truncate-1 { display:block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .truncate-2 { display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; }

    /* --- Móvil ----------------------------------------------------------- */
    @media (max-width: 720px) {
      body { padding: max(env(safe-area-inset-top), 14px) 14px max(env(safe-area-inset-bottom), 14px); }
      main { gap: 16px; }
      section { padding: 14px; border-radius: 14px; }
      h1 { font-size: 1.4rem; }
      h2 { font-size: 1rem; }

      input, select, button { min-height: 38px; font-size: 15px; padding: 8px 12px; border-radius: 10px; }
      .btns { gap: 6px; }
      button.sm { min-height: 28px; padding: 6px 8px; font-size: 11px; }
      .icon { width: 14px; height: 14px; }
      /* Oculta texto en botones de tablas; iconos + aria-label */
      .btns .btn-text { display:none; }

      /* Tarjetas */
      thead { display: none; }
      table.responsive { table-layout: auto; border-radius: 0; background: transparent; box-shadow: none; }
      table.responsive tbody { display: grid; gap: 10px; }
      table.responsive tr { display: grid; gap: 8px; padding: 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,.12); box-shadow: 0 8px 20px rgba(0,0,0,.12); background: var(--panel); }

      /* CELDA: 2 columnas -> etiqueta (fija) + valor (fluido)  */
      table.responsive td {
        display: grid;
        grid-template-columns: var(--label-w) 1fr;
        align-items: start;
        gap: 8px;
        padding: 0;
        border: 0;
        text-align: left; /* valor a la izquierda */
        font-size: .95rem;
      }
      table.responsive td::before {
        content: attr(data-label-short);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .04em;
        font-size: .72rem;
        color: var(--ink-strong);
        text-align: left;
      }
      table.responsive td .cell-value {
        min-width: 0;
        padding-left: 8px;
        border-left: 1px solid rgba(0,0,0,.15); /* separador vertical opcional */
      }
      /* Separador horizontal entre "filas" de la tarjeta */
      table.responsive tr > td + td {
        margin-top: 6px;
        padding-top: 8px;
        border-top: 1px dashed rgba(0,0,0,.15);
      }

      /* Ajustes de badges y acciones */
      table.responsive td .badge { justify-self: start; }
      table.responsive td:last-child .cell-value { border-left-style: solid; }
    }

    /* --- Aún más estrecho ------------------------------------------------ */
    @media (max-width: 360px) {
      :root { --label-w: 74px; }
    }

    /* Medium screens */
    @media (max-width: 960px) { th, td { padding: 10px 12px; } }

    /* Accessibility helpers */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    [hidden] { display: none !important; }
  
/* Logo junto al título */
h1 .logo { width: 32px; height: 32px; border-radius: 8px; vertical-align: -6px; margin-right: 8px; }
</style>
</head>
<body>
  <main>
    <!-- Barra de título con botón a la derecha -->
    <header class="titlebar">
      <h1><img src="/icons/icon-192.png" class="logo" alt="" width="32" height="32" decoding="async"> vuzon</h1>
      <button id="refreshAll" class="secondary sm" type="button" aria-label="Actualizar destinatarios y alias">
        <span class="spinner" aria-hidden="true" hidden></span>
        <span class="btn-label">Actualizar</span>
      </button>
    </header>

    <section aria-labelledby="sec-crear">
      <header>
        <h2 id="sec-crear">Crear alias</h2>
      </header>
      <div class="stack">
        <label for="localPart">Alias</label>
        <div class="table-actions">
          <input id="localPart" placeholder="alias" autocapitalize="off" autocomplete="off" spellcheck="false">
          <button id="gen" class="secondary" type="button">Generar</button>
        </div>
        <label for="destSel">Enviar a</label>
        <select id="destSel" aria-label="Selecciona destinatario"></select>
        <div class="section-actions" style="justify-content:flex-end">
          <button id="create" type="button">Crear alias</button>
        </div>
      </div>
    </section>

<section aria-labelledby="sec-destinatarios" class="collapsible">
      <header>
        <h2 id="sec-destinatarios">Destinatarios</h2>
        <button id="toggleDestinatarios" class="secondary sm" type="button" aria-expanded="false" aria-controls="destinatarios-content" aria-label="Mostrar u ocultar destinatarios">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg><span class="btn-text">Mostrar</span>
        </button>
      </header>

      <div id="destinatarios-content" hidden>
        <div class="stack">
        <div class="stack">
          <label for="newDest">Añadir destinatario</label>
          <div class="table-actions">
            <input id="newDest" type="email" inputmode="email" autocomplete="email" placeholder="destino@ejemplo.com" aria-describedby="newDestHelp">
            <button id="addDest" type="button">Añadir</button>
          </div>
          <p id="newDestHelp" class="sr-only">Introduce un correo válido y pulsa Añadir.</p>
        </div>

        <div class="table-container">
          <table id="destTbl" class="responsive" aria-describedby="destCaption">
            <caption id="destCaption" class="sr-only">Lista de destinatarios de reenvío</caption>
            <thead>
              <tr><th>Email</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      </div>
    </section>

    

    <section aria-labelledby="sec-existentes" class="collapsible">
  <header>
    <h2 id="sec-existentes">Alias existentes</h2>
    <button id="toggleExistentes" class="secondary sm" type="button" aria-expanded="false" aria-controls="existentes-content" aria-label="Mostrar u ocultar alias existentes">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg><span class="btn-text">Mostrar</span>
    </button>
  </header>
<div id="existentes-content" hidden>
      <div id="rulesList" class="rule-card-list" aria-live="polite" aria-label="Lista de alias existentes"></div>
    </div>
</section>
<div class="page-spacer" aria-hidden="true"></div>

    <p id="status" role="status" aria-live="polite" class="sr-only"></p>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const destTbl = $('#destTbl tbody');
    const rulesList = $('#rulesList');
    const destSel = $('#destSel');
    const status = $('#status');

    const statusManager = (() => {
      const operations = new Map();
      let looseMessage = '';

      const getOpsArray = () => Array.from(operations.values());
      const update = () => {
        const ops = getOpsArray();
        const error = [...ops].reverse().find(op => op.state === 'error');
        if (error) {
          status.textContent = error.message;
          return;
        }
        const loading = [...ops].reverse().find(op => op.state === 'loading');
        if (loading) {
          status.textContent = loading.message;
          return;
        }
        status.textContent = looseMessage;
      };

      return {
        start(id, message) {
          operations.set(id, { state: 'loading', message });
          update();
        },
        succeed(id, message) {
          operations.delete(id);
          if (message !== undefined) {
            looseMessage = message;
          } else if (!operations.size) {
            looseMessage = '';
          }
          update();
        },
        fail(id, message) {
          operations.set(id, { state: 'error', message });
          update();
        },
        info(message = '') {
          looseMessage = message;
          update();
        },
        clearInfoIfIdle() {
          if (!operations.size) {
            looseMessage = '';
            update();
          }
        },
        hasErrors() {
          return getOpsArray().some(op => op.state === 'error');
        }
      };
    })();

    const setStatus = (msg = '') => statusManager.info(msg);
    const safeJoin = (val) => Array.isArray(val) ? val.join(', ') : (val ?? '');

    const on = (el, evt, sel, fn) => el.addEventListener(evt, e => {
      const t = e.target.closest(sel); if (t) fn(e, t);
    });

    function renderBadge(isVerified) {
      return isVerified
        ? '<span class="badge success">Verificado</span>'
        : '<span class="badge pending">Pendiente</span>';
    }

    // Iconos inline (copy / trash)
    const ICONS = {
      copy: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>',
      trash: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>',
      pause: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>',
      play: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polygon points="6 4 20 12 6 20 6 4"/></svg>'
    };

    async function api(path, opts = {}) {
      const { headers = {}, ...rest } = opts;
      try {
        const res = await fetch(path, { headers: { Accept: 'application/json', ...headers }, ...rest });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json().catch(() => ({}));
        return data;
      } catch (err) {
        console.error(err);
        throw err;
      }
    }

    function esc(str='') {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    async function loadDests() {
      statusManager.start('loadDests', 'Cargando destinatarios…');
      destTbl.innerHTML = '';
      destSel.innerHTML = '';
      try {
        const d = await api('/api/addresses');
        const rawList = Array.isArray(d.result) ? d.result : d.result?.result ?? d.result ?? [];
        const list = Array.isArray(rawList) ? rawList : [];
        (list || []).forEach(a => {
          const email = a.email || '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Email" data-label-short="Email">
              <span class="cell-value truncate-1" title="${esc(email)}">${esc(email)}</span>
            </td>
            <td data-label="Estado" data-label-short="Estado">
              <span class="cell-value">${renderBadge(!!a.verified)}</span>
            </td>
            <td data-label="Acciones" data-label-short="Acciones">
              <span class="cell-value">
                <div class="btns">
                  <button data-id="${esc(a.id)}" class="copy-id secondary sm" type="button" aria-label="Copiar ID del destinatario">
                    ${ICONS.copy}<span class="btn-text">Copiar ID</span>
                  </button>
                  <button data-id="${esc(a.id)}" class="del-d secondary sm" type="button" aria-label="Borrar destinatario">
                    ${ICONS.trash}<span class="btn-text">Borrar</span>
                  </button>
                </div>
              </span>
            </td>
          `.trim();
          destTbl.appendChild(tr);

          const opt = document.createElement('option');
          opt.value = email;
          opt.textContent = `${email}${a.verified ? '' : ' (no verificado)'}`;
          opt.disabled = !a.verified;
          destSel.appendChild(opt);
        });
        statusManager.succeed('loadDests');
      } catch {
        statusManager.fail('loadDests', 'No se pudieron cargar los destinatarios.');
      }
    }

    async function loadRules() {
      if (!rulesList) return;
      statusManager.start('loadRules', 'Cargando alias…');
      rulesList.innerHTML = '';
      try {
        const d = await api('/api/rules');
        const rawList = Array.isArray(d.result) ? d.result : d.result?.result ?? d.result ?? [];
        const items = Array.isArray(rawList) ? rawList : [];
        if (!items.length) {
          rulesList.innerHTML = '<p class="rule-empty">No hay alias configurados.</p>';
        }
        items.forEach(rule => {
          const matcherTexts = (rule.matchers || []).map(m => `${m.field}: ${m.value}`);
          const to = matcherTexts.join(', ');
          const primaryEmail = (rule.matchers || []).find(m => m.field === 'to')?.value
            || (rule.matchers || [])[0]?.value
            || rule.name
            || 'Alias';
          const act = (rule.actions || []).map(a => {
            const values = a.value ?? a.values ?? [];
            return `${a.type}→${safeJoin(values)}`;
          }).join('; ');
          const toDisplay = to || '—';
          const actionDisplay = act || '—';
          const idVal = rule.id || rule.tag || '';
          const toggleBtn = rule.enabled
            ? `<button data-id="${esc(idVal)}" class="disable-r secondary sm" type="button" aria-label="Deshabilitar alias">${ICONS.pause}<span class="btn-text">Deshabilitar</span></button>`
            : `<button data-id="${esc(idVal)}" class="enable-r secondary sm" type="button" aria-label="Habilitar alias">${ICONS.play}<span class="btn-text">Habilitar</span></button>`;
          const stateBadge = rule.enabled
            ? '<span class="badge success">Activo</span>'
            : '<span class="badge pending">Inactivo</span>';

          const card = document.createElement('details');
          card.className = 'rule-card';
          card.innerHTML = `
            <summary>
              <span class="rule-summary">
                <span class="rule-title" title="${esc(primaryEmail)}">${esc(primaryEmail)}</span>
                ${stateBadge}
              </span>
            </summary>
            <div class="rule-content">
              <div class="rule-field">
                <span class="rule-label">Filtro</span>
                <span class="rule-value">${esc(toDisplay)}</span>
              </div>
              <div class="rule-field">
                <span class="rule-label">Acción</span>
                <span class="rule-value">${esc(actionDisplay)}</span>
              </div>
              <div class="rule-field">
                <span class="rule-label">Estado</span>
                <span class="rule-value">${stateBadge}</span>
              </div>
              <div class="rule-field">
                <span class="rule-label">Acciones</span>
                <span class="rule-value">
                  <div class="btns">
                    <button data-id="${esc(idVal)}" class="copy-id secondary sm" type="button" aria-label="Copiar ID de la regla">
                      ${ICONS.copy}<span class="btn-text">Copiar ID</span>
                    </button>
                    ${toggleBtn}
                    <button data-id="${esc(idVal)}" class="del-r secondary sm" type="button" aria-label="Borrar regla">
                      ${ICONS.trash}<span class="btn-text">Borrar</span>
                    </button>
                  </div>
                </span>
              </div>
            </div>
          `.trim();
          rulesList.appendChild(card);
        });
        statusManager.succeed('loadRules');
      } catch {
        statusManager.fail('loadRules', 'No se pudieron cargar las reglas.');
      }
    }

    // --- Copiar ID al portapapeles --------------------------------------
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setStatus('ID copiado al portapapeles.');
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = text; ta.setAttribute('readonly', ''); ta.style.position = 'absolute'; ta.style.left = '-9999px';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); setStatus('ID copiado al portapapeles.'); }
        catch { setStatus('No se pudo copiar el ID.'); }
        finally { document.body.removeChild(ta); }
      }
    }

    on(destTbl, 'click', '.copy-id', (_e, btn) => copyToClipboard(btn.getAttribute('data-id') || ''));
    if (rulesList) {
      on(rulesList, 'click', '.copy-id', (_e, btn) => copyToClipboard(btn.getAttribute('data-id') || ''));
      on(rulesList, 'click', '.del-r', async (_e, btn) => {
        const id = btn.getAttribute('data-id');
        if (!confirm('¿Borrar alias?')) return;
        btn.disabled = true;
        try {
          await api('/api/rules/' + encodeURIComponent(id), { method: 'DELETE' });
          await loadRules();
        } catch {
          alert('Error al borrar alias');
        } finally {
          btn.disabled = false;
        }
      });

      on(rulesList, 'click', '.disable-r', async (_e, btn) => {
        const id = btn.getAttribute('data-id');
        if (!confirm('¿Deshabilitar alias?')) return;
        btn.disabled = true;
        try { await api(`/api/rules/${encodeURIComponent(id)}/disable`, { method: 'POST' }); await loadRules(); }
        catch { alert('Error al deshabilitar alias'); }
        finally { btn.disabled = false; }
      });

      on(rulesList, 'click', '.enable-r', async (_e, btn) => {
        const id = btn.getAttribute('data-id');
        btn.disabled = true;
        try { await api(`/api/rules/${encodeURIComponent(id)}/enable`, { method: 'POST' }); await loadRules(); }
        catch { alert('Error al habilitar alias'); }
        finally { btn.disabled = false; }
      });
    }

    // --- Colapsable 'Destinatarios' --------------------------------------
const toggleDestinatarios = $('#toggleDestinatarios');
const destinatariosContent = $('#destinatarios-content');
if (toggleDestinatarios && destinatariosContent) {
  toggleDestinatarios.addEventListener('click', () => {
    const expanded = toggleDestinatarios.getAttribute('aria-expanded') === 'true';
    toggleDestinatarios.setAttribute('aria-expanded', String(!expanded));
    destinatariosContent.hidden = expanded;
    const txt = toggleDestinatarios.querySelector('.btn-text');
    if (txt) txt.textContent = expanded ? 'Mostrar' : 'Ocultar';
  });
}

    // --- Colapsable 'Alias existentes' ----------------------------------
    const toggleExistentes = $('#toggleExistentes');
    const existentesContent = $('#existentes-content');
    if (toggleExistentes && existentesContent) {
      toggleExistentes.addEventListener('click', () => {
        const expanded = toggleExistentes.getAttribute('aria-expanded') === 'true';
        toggleExistentes.setAttribute('aria-expanded', String(!expanded));
        existentesContent.hidden = expanded;
        const txt = toggleExistentes.querySelector('.btn-text');
        if (txt) txt.textContent = expanded ? 'Mostrar' : 'Ocultar';
      });
    }

    // --- Eventos UI ------------------------------------------------------
    $('#addDest').addEventListener('click', async () => {
      const input = $('#newDest');
      const email = input.value.trim();
      if (!email) return alert('Email requerido');
      input.disabled = true; $('#addDest').disabled = true;
      try {
        await api('/api/addresses', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
        input.value = '';
        await loadDests();
      } catch { alert('No se pudo añadir el destinatario'); }
      finally { input.disabled = false; $('#addDest').disabled = false; }
    });

    $('#newDest').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('#addDest').click(); });

    // Botón "Actualizar" junto al título (con spinner)
    $('#refreshAll').addEventListener('click', async () => {
      const btn = $('#refreshAll');
      const lbl = btn.querySelector('.btn-label');
      const spn = btn.querySelector('.spinner');
      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      lbl.textContent = 'Actualizando…';
      spn.hidden = false;

      statusManager.info('Actualizando…');
      await Promise.allSettled([loadDests(), loadRules()]);
      if (!statusManager.hasErrors()) {
        statusManager.clearInfoIfIdle();
      }

      lbl.textContent = 'Actualizar';
      spn.hidden = true;
      btn.removeAttribute('aria-busy');
      btn.disabled = false;
    });

    $('#gen').addEventListener('click', () => {
      $('#localPart').value = Math.random().toString(36).slice(2, 10);
    });

    $('#create').addEventListener('click', async () => {
      const lp = $('#localPart').value.trim();
      const de = destSel.value;
      if (!lp || !de) return alert('Falta alias o destinatario verificado');
      const btn = $('#create'); btn.disabled = true;
      try {
        await api('/api/rules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ localPart: lp, destEmail: de }) });
        $('#localPart').value = '';
        await loadRules();
      } catch { alert('No se pudo crear el alias'); }
      finally { btn.disabled = false; }
    });

    on(destTbl, 'click', '.del-d', async (_e, btn) => {
      const id = btn.getAttribute('data-id');
      if (!confirm('¿Borrar destinatario?')) return;
      btn.disabled = true;
      try {
        await api('/api/addresses/' + encodeURIComponent(id), { method: 'DELETE' });
        await loadDests();
      } catch {
        alert('Error al borrar destinatario');
      } finally {
        btn.disabled = false;
      }
    });

    // Carga inicial
    loadDests();
    loadRules();
  </script>
</body>
</html>
